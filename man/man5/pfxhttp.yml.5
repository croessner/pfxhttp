.TH PFXHTTP.YML 5 "January 2025" "pfxhttp 1.0" "Configuration Files"
.SH NAME
pfxhttp.yml \- Configuration file for pfxhttp, an HTTP Proxy for Postfix

.SH DESCRIPTION
The \fBpfxhttp.yml\fP file is a YAML-based configuration file that controls the behavior of \fBpfxhttp\fP. This tool enables Postfix to utilize HTTP-based services as socket maps or policy services, providing flexibility for custom integrations.

A typical configuration consists of the following main sections:

.IP
* \fBserver\fP: Global server settings, including logging, communication settings, HTTP client behavior, and optional TLS configuration.
.IP
* \fBsocket_maps\fP: Definitions of socket maps that can be used by Postfix for dynamic lookups.
.IP
* \fBpolicy_services\fP: Definitions of policy services for validating or processing Postfix requests.
.IP
* \fBdovecot_sasl\fP: Definitions for Dovecot SASL authentication services.

.SH CONFIGURATION
The configuration file uses the YAML format, containing key-value pairs organized hierarchically. Below are the main sections explained in detail:

.SS SERVER
The \fBserver\fP section provides global settings for how \fBpfxhttp\fP operates, including logging, communication settings, HTTP client behavior, and optional TLS configuration.

.nf
.EXAMPLE
server:
  listen:
    - kind: "socket_map"
      name: "map"
      type: "tcp"
      address: "0.0.0.0"
      port: 23450
  logging:
    json: false
    level: debug
  http_client:
    timeout: 30s
    max_connections_per_host: 10
    max_idle_connections: 4
    max_idle_connections_per_host: 1
    idle_connection_timeout: 10s
    proxy: "http://proxy.example.com:3128"
  tls:
    enabled: true
    cert: "/etc/pfxhttp/cert.pem"
    key: "/etc/pfxhttp/key.pem"
    root_ca: "/etc/ssl/certs/ca-certificates.crt"
    skip_verify: true
  socketmap_max_reply_size: 100000
  response_cache:
    enabled: true
    ttl: 1m
  worker_pool:
    max_workers: 10
    max_queue: 100
.fi
.RE

.TP
.B listen
Configures the connections \fBpfxhttp\fP listens to for requests.
.RS
.IP \[bu] 2
.B kind:
Specifies the type of service (\fBsocket_map\fP, \fBpolicy_service\fP, or \fBdovecot_sasl\fP).
.IP \[bu] 2
.B type:
The connection type. Can be \fBunix\fP, \fBtcp\fP, or \fBtcp6\fP.
.IP \[bu] 2
.B name:
Optional for \fBsocket_map\fP, but required for \fBpolicy_service\fP and \fBdovecot_sasl\fP.
.IP \[bu] 2
.B address:
For \fBtcp\fP or \fBtcp6\fP, the network address to bind to (e.g., \fB0.0.0.0\fP). For \fBunix\fP, the filesystem path to the Unix domain socket.
.IP \[bu] 2
.B port:
The port used to listen for connections. Relevant only for \fBtcp\fP and \fBtcp6\fP types.
.IP \[bu] 2
.B mode:
Applicable only for \fBunix\fP sockets. Sets the socket's access permissions as an octal value, such as \fB0666\fP.
.IP \[bu] 2
.B user:
Applicable only for \fBunix\fP sockets. Sets the socket's owner (username or UID). Requires \fBCAP_CHOWN\fP.
.IP \[bu] 2
.B group:
Applicable only for \fBunix\fP sockets. Sets the socket's group (groupname or GID). Requires \fBCAP_CHOWN\fP.
.RE

.TP
.B logging
Specifies logging behavior.
.RS
.IP \[bu] 2
.B json:
Enables JSON format logging (\fBtrue\fP or \fBfalse\fP).
.IP \[bu] 2
.B level:
Sets the verbosity of logs. Options are \fBnone\fP, \fBerror\fP, \fBinfo\fP, or \fBdebug\fP.
.RE

.TP
.B http_client
Configures the behavior of the HTTP client used by \fBpfxhttp\fP.
.RS
.IP \[bu] 2
.B timeout:
The total timeout for HTTP requests. This is a Go duration string (e.g., \fB30s\fP, \fB1m\fP). Range: 1s to 1h.
.IP \[bu] 2
.B max_connections_per_host:
Maximum number of concurrent connections per host.
.IP \[bu] 2
.B max_idle_connections:
Maximum number of idle connections allowed in total.
.IP \[bu] 2
.B max_idle_connections_per_host:
Maximum idle connections per host.
.IP \[bu] 2
.B idle_connection_timeout:
Timeout for idle connections. This is a Go duration string (e.g., \fB500ms\fP, \fB10s\fP, \fB1m\fP). Range: 1ms to 1h.
.IP \[bu] 2
.B proxy:
HTTP proxy URL to use for outbound requests (e.g., \fBhttp://proxy.example.com:3128\fP).
.RE

.TP
.B tls
TLS configuration for secure HTTP connections. All fields are optional.
.RS
.IP \[bu] 2
.B enabled:
Enables or disables TLS (\fBtrue\fP or \fBfalse\fP).
.IP \[bu] 2
.B cert:
Path to the TLS certificate (optional).
.IP \[bu] 2
.B key:
Path to the TLS private key (optional).
.IP \[bu] 2
.B root_ca:
Path to a custom root CA certificate file (optional).
.IP \[bu] 2
.B skip_verify:
If \fBtrue\fP, disables verification of peer certificates by the HTTP client.
.RE

.TP
.B socketmap_max_reply_size
Specifies the maximum reply size for socket maps. Defaults to \fB100000\fP if not explicitly configured.

.TP
.B response_cache
Configures caching of HTTP responses.
.RS
.IP \[bu] 2
.B enabled:
Enable or disable the in-memory response cache (true/false).
.IP \[bu] 2
.B ttl:
Time-to-live for cached responses as a Go duration string (e.g., 30s, 1m, 10m). Range: 1s to 168h.
.RE

.TP
.B worker_pool
Configures a worker pool to manage concurrent connections and provide back-pressure.
.RS
.IP \[bu] 2
.B max_workers:
Maximum number of concurrent workers. If not configured in the \fBserver\fP section, it defaults to \fB2 * GOMAXPROCS\fP.
.IP \[bu] 2
.B max_queue:
Maximum number of connections waiting in the queue. If not configured, it defaults to \fB10 * max_workers\fP.
.RE

.SS SOCKET_MAPS
The \fBsocket_maps\fP section defines services used by Postfix to perform dynamic lookups. This functionality is commonly used for querying an external service to map a key (e.g., an email address or domain) to a value.

.nf
.EXAMPLE
socket_maps:
  demo_map:
    target: "https://your-api.example.com/api/v1/map"
    custom_headers:
      - "Authorization: Bearer <token>"
    payload: >
      {
        "key": "{{ .Key }}"
      }
    status_code: 200
    value_field: "data.result"
    error_field: "error"
    no_error_value: "not-found"

  oidc_demo_map:
    target: "https://your-api.example.com/api/v1/map"
    oidc_auth:
      enabled: true
      configuration_uri: "https://your-auth.example.com/.well-known/openid-configuration"
      client_id: "your-client-id"
      client_secret: "your-client-secret"
    payload: >
      {
        "key": "{{ .Key }}"
      }
    status_code: 200
    value_field: "data.result"
    error_field: "error"
    no_error_value: "not-found"
.fi
.RE

.TP
.B http_request_compression
If true, compresses HTTP request bodies with gzip.

.TP
.B http_response_compression
If true, sends an Accept-Encoding header to request gzip-compressed responses.

.TP
.B oidc_auth
Configures OIDC authentication for the socket map.
.RS
.IP \[bu] 2
.B enabled:
Enables or disables OIDC authentication (\fBtrue\fP or \fBfalse\fP).
.IP \[bu] 2
.B configuration_uri:
The URL of the OpenID configuration endpoint (e.g., \fBhttps://auth.example.com/.well-known/openid-configuration\fP).
.IP \[bu] 2
.B client_id:
The client identifier.
.IP \[bu] 2
.B client_secret:
The client secret (for client_secret_basic authentication).
.IP \[bu] 2
.B private_key_file:
Path to the PEM-encoded private key (for private_key_jwt authentication).
.IP \[bu] 2
.B scopes:
A list of scopes to request.
.RE

.TP
.B payload
Defines the HTTP request body for socket maps. The placeholder \fB{{ .Key }}\fP is required and represents the lookup key provided by Postfix.

.SS POLICY_SERVICES
The \fBpolicy_services\fP section defines external HTTP services used for Postfix policy decisions. Examples include sender authentication or access restriction checks.

.nf
.EXAMPLE
policy_services:
  example_policy:
    target: "https://your-api.example.com/api/v1/policy/check"
    custom_headers:
      - "Authorization: Bearer <token>"
    payload: "{{ .Key }}"
    status_code: 200
    value_field: "policy.result"
    error_field: "policy.error"
    no_error_value: "OK"

  oidc_example_policy:
    target: "https://your-api.example.com/api/v1/policy/check"
    oidc_auth:
      enabled: true
      configuration_uri: "https://your-auth.example.com/.well-known/openid-configuration"
      client_id: "your-client-id"
      client_secret: "your-client-secret"
    payload: "{{ .Key }}"
    status_code: 200
    value_field: "policy.result"
    error_field: "policy.error"
    no_error_value: "OK"
.fi
.RE

.TP
.B http_request_compression
If true, compresses HTTP request bodies with gzip.

.TP
.B http_response_compression
If true, sends an Accept-Encoding header to request gzip-compressed responses.

.TP
.B oidc_auth
Configures OIDC authentication for the policy service.
.RS
.IP \[bu] 2
.B enabled:
Enables or disables OIDC authentication (\fBtrue\fP or \fBfalse\fP).
.IP \[bu] 2
.B configuration_uri:
The URL of the OpenID configuration endpoint.
.IP \[bu] 2
.B client_id:
The client identifier.
.IP \[bu] 2
.B client_secret:
The client secret.
.IP \[bu] 2
.B private_key_file:
Path to the PEM-encoded private key.
.IP \[bu] 2
.B scopes:
A list of scopes to request.
.RE

.TP
.B payload
Defines the HTTP request body for policy services. The placeholder \fB{{ .Key }}\fP is required and is replaced with the JSON-encoded policy request provided by Postfix. This request contains all available policy attributes. The payload can also be passed as a nested JSON structure, for example:
.nf

Payload:
{
  "policy_request": {{ .Key }}
}
.fi

.TP
.B value_field
The JSON field in the HTTP response containing the policy result to be returned to Postfix.

.TP
.B no_error_value
A specific value that may be returned by the HTTP server to indicate no error occurred.

.SH POSTFIX INTEGRATION
Below are examples for incorporating the \fBsocket_map\fP and \fBpolicy_service\fP types in Postfix configurations. These examples assume a correctly configured pfxhttp server.

.SS SOCKET_MAP INTEGRATION
To use a \fBsocket_map\fP in your Postfix configuration, include it as a socket map in your `main.cf`:

.nf
# main.cf
virtual_mailbox_domains = socketmap:tcp:127.0.0.1:23450:demo_map
.fi

This example assumes:
- A listener in \fBpfxhttp.yml\fP is defined for \fBsocket_map\fP:
.nf
server:
  listen:
    - kind: "socket_map"
      name: "demo_map"
      type: "tcp"
      address: "127.0.0.1"
      port: 23450
.fi

Explanation:
- Postfix connects to the \fBtcp\fP listener on `127.0.0.1:23450`.
- The lookup key is provided from Postfix's requests (e.g., domain names).
- The result is returned from the \fBpfxhttp\fP service.

.SS POLICY_SERVICE INTEGRATION
To implement a \fBpolicy_service\fP, add it to the appropriate Postfix \fBcheck_policy_service\fP configuration (commonly used in the `smtpd_recipient_restrictions`):

.nf
# main.cf
smtpd_recipient_restrictions =
    permit_mynetworks,
    reject_unauth_destination,
    check_policy_service inet:127.0.0.1:23451
.fi

This example assumes:
- A listener for a \fBpolicy_service\fP is configured in \fBpfxhttp.yml\fP:
.nf
server:
  listen:
    - kind: "policy_service"
      name: "example_policy"
      type: "tcp"
      address: "127.0.0.1"
      port: 23451
.fi

Explanation:
- The payload sent to the HTTP service uses the Postfix policy request converted to JSON, passed as \fB{{ .Key }}\fP.
- Postfix queries the policy service for decisions based on this request.
- The policy service responds with actions like `DUNNO`, `REJECT`, or other return codes to modify Postfixâ€™s behavior.

.SH FILE LOCATIONS
Configuration files are searched in the following order:
.RS
.IP \[bu] 2
.B /usr/local/etc/pfxhttp/pfxhttp.yml
.IP \[bu] 2
.B /etc/pfxhttp/pfxhttp.yml
.IP \[bu] 2
.B $HOME/.pfxhttp/pfxhttp.yml
.IP \[bu] 2
.B ./pfxhttp.yml
.RE

.SH OIDC AUTHENTICATION
The \fBpfxhttp\fP application supports OpenID Connect (OIDC) Client Credentials Flow for secure communication with HTTP services.

.SS OVERVIEW
OIDC authentication provides a standardized way to authenticate requests using access tokens. The application manages the token lifecycle, including:

.IP \[bu] 2
Discovery of OIDC endpoints via the OpenID configuration URI
.IP \[bu] 2
Fetching access tokens using the \fBclient_credentials\fP grant type
.IP \[bu] 2
Support for \fBclient_secret\fP and \fBprivate_key_jwt\fP authentication
.IP \[bu] 2
In-memory caching of tokens to improve performance

.SS CONFIGURATION
To enable OIDC authentication, configure the \fBoidc_auth\fP section for a socket map or policy service:

.nf
socket_maps:
  example_map:
    target: "https://api.example.com/map"
    oidc_auth:
      enabled: true
      configuration_uri: "https://auth.example.com/.well-known/openid-configuration"
      client_id: "your-client-id"
      client_secret: "your-client-secret"
.fi

.SH SEE ALSO
.BR postfix (1),
.BR pfxhttp (8)

.SH AUTHOR
This manpage was written by the pfxhttp development team.

.SH DOVECOT_SASL
The \fBdovecot_sasl\fP section defines services for authenticating Postfix via the Dovecot SASL protocol.
Unlike \fBsocket_maps\fP and \fBpolicy_services\fP, the request payload is not configurable:
\fBpfxhttp\fP constructs the JSON body for Nauthilus' \fB/api/v1/auth/json\fP endpoint automatically from the SASL exchange.

.TP
.B Request mapping
The following fields are sent when available:
.RS
.IP \[bu] 2
username, password
.IP \[bu] 2
protocol (from Dovecot service, e.g. smtp)
.IP \[bu] 2
method (SASL mechanism, e.g. PLAIN/LOGIN)
.IP \[bu] 2
client_ip, client_port, local_ip, local_port
.IP \[bu] 2
ssl (set when the connection is secured), ssl_protocol, ssl_cipher
.IP \[bu] 2
client_id
.RE

.TP
.B Response handling
Pfxhttp evaluates the HTTP status code as the primary success indicator. On failures, the optional
\fBAuth-Status\fP HTTP response header (set by Nauthilus) is used as the human-readable reason. On success,
Pfxhttp may read the optional JSON field \fBaccount_field\fP to obtain the resolved username; this can be overridden
via \fBvalue_field\fP in the configuration. The \fBpayload\fP key is ignored for \fBdovecot_sasl\fP blocks and should not be configured.
