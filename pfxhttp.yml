---
# pfxhttp config file

server:

  run_as_user: "pfxhttp"
  run_as_group: "pfxhttp"

  listen:
    - kind: "socket_map"
      name: "map"
      type: "tcp"
      address: "0.0.0.0"
      port: 23450

    - kind: "policy_service"
      name: "policy"
      type: "tcp"
      address: "0.0.0.0"
      port: 23451

    - kind: "policy_service"
      name: "oidc_policy"
      type: "tcp"
      address: "0.0.0.0"
      port: 23452

    - kind: "dovecot_sasl"
      name: "dovecot_sasl"
      type: "tcp"
      address: "0.0.0.0"
      port: 23453

  logging:
    json: false
    level: debug

  http_client:
    timeout: 30s
    max_connections_per_host: 10
    max_idle_connections: 4
    max_idle_connections_per_host: 1
    idle_connection_timeout: 10s
    # proxy: "http://proxy.example.com:8080"

  tls:
    enabled: true
    skip_verify: true
    # root_ca: "/etc/ssl/certs/ca-certificates.crt"

  # Default Postfix limit
  socketmap_max_reply_size: 100000

  response_cache:
    enabled: true
    ttl: 1m

  worker_pool:
    max_workers: 10
    max_queue: 100

socket_maps:

  demo:
    target: https://127.0.0.1:9443/api/v1/custom/postfix/socket_map
    http_request_compression: true
    http_response_compression: true
    custom_headers:
      # User 'test', password 'test'
      - "Authorization: Basic dGVzdDp0ZXN0"
    payload: >
      {
        "key": "{{ .Key }}"
      }
    status_code: 200
    value_field: "demo_value"
    error_field: "error"
    no_error_value: "none"

  oidc_demo:
    target: https://127.0.0.1:9443/api/v1/custom/postfix/socket_map
    oidc_auth:
      enabled: true
      configuration_uri: https://127.0.0.1:9443/.well-known/openid-configuration
      client_id: admin
      client_secret: admin-password
    payload: >
      {
        "key": "{{ .Key }}"
      }
    status_code: 200
    value_field: "demo_value"
    error_field: "error"
    no_error_value: "none"

policy_services:

  policy:
    target: https://127.0.0.1:9443/api/v1/custom/postfix/policy_service
    http_request_compression: false
    http_response_compression: true
    custom_headers:
      # User 'test', password 'test'
      - "Authorization: Basic dGVzdDp0ZXN0"
    payload: "{{ .Key }}"
    status_code: 200
    value_field: "result"
    error_field: "error"
    no_error_value: "none"

  oidc_policy:
    target: https://127.0.0.1:9443/api/v1/custom/postfix/policy_service
    oidc_auth:
      enabled: true
      configuration_uri: https://127.0.0.1:9443/.well-known/openid-configuration
      client_id: admin
      client_secret: admin-password
    payload: "{{ .Key }}"
    status_code: 200
    value_field: "result"
    error_field: "error"
    no_error_value: "none"

dovecot_sasl:

  dovecot_sasl:
    target: https://127.0.0.1:9443/api/v1/auth/json
    oidc_auth:
      enabled: true
      configuration_uri: https://127.0.0.1:9443/.well-known/openid-configuration
      client_id: admin
      client_secret: admin-password
      # account_claim: "dovecot_account"
    # Note: For dovecot_sasl, the payload is generated internally according to Nauthilus
    # /api/v1/auth/json; a payload entry has no effect here.
    status_code: 200
    # Username is returned via HTTP response header "Auth-User" by the backend.
    # Errors are signaled via HTTP status and the "Auth-Status" header.
